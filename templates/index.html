<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickDesk - Modern Help Desk</title>
    <style>
        /* --- CSS Variables for Theming --- */
:root {
    /* Colors */
    --primary-color: #007bff; /* Vibrant Blue */
    --primary-dark: #0056b3;
    --primary-light: #e6f2ff; /* Lightest tint for backgrounds */
    --secondary-color: #6c757d; /* Muted Grey */
    --secondary-dark: #5a6268;
    --accent-color: #17a2b8; /* Teal for Info */
    --success-color: #28a745; /* Green */
    --danger-color: #dc3545; /* Red */
    --warning-color: #ffc107; /* Yellow */

    /* Backgrounds */
    --body-bg: #f8f9fa; /* Light background */
    --card-bg: #ffffff;
    --input-bg: #f0f2f5; /* Light grey for inputs */
    --border-color: #e9ecef;
    --shadow-color: rgba(0, 0, 0, 0.08);

    /* Text Colors */
    --text-color-primary: #343a40; /* Darker grey for main text */
    --text-color-secondary: #6c757d; /* Lighter grey for meta text */
    --text-color-light: #adb5bd; /* Very light grey for placeholders/help text */

    /* Typography */
    --font-family-sans: 'Inter', sans-serif;
    --font-size-base: 1rem;
    --line-height-base: 1.6;

    /* Spacing */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --spacing-xxl: 3rem;

    /* Borders & Shadows */
    --border-radius-sm: 4px;
    --border-radius-md: 8px;
    --border-radius-lg: 12px;
    --shadow-elevation-1: 0 1px 3px var(--shadow-color), 0 1px 2px var(--shadow-color);
    --shadow-elevation-2: 0 3px 6px var(--shadow-color), 0 3px 6px var(--shadow-color);
    --shadow-elevation-3: 0 10px 20px var(--shadow-color), 0 6px 6px var(--shadow-color);

    /* Status Tags */
    --status-open-bg: #ffe0b2; /* Light Orange */
    --status-open-text: #e65100; /* Dark Orange */
    --status-in-progress-bg: #bbdefb; /* Light Blue */
    --status-in-progress-text: #0d47a1; /* Dark Blue */
    --status-resolved-bg: #c8e6c9; /* Light Green */
    --status-resolved-text: #2e7d32; /* Dark Green */
    --status-closed-bg: #cfd8dc; /* Light Grey */
    --status-closed-text: #455a64; /* Dark Grey */

    /* Transition */
    --transition-speed: 0.3s ease;
}

/* --- Dark Mode Variables --- */
body[data-theme='dark'] {
    --primary-color: #79a6ff;
    --primary-dark: #5c84e0;
    --primary-light: #2c3a50;
    --secondary-color: #aeb9c3;
    --secondary-dark: #8c969e;
    --accent-color: #4dc2d9;
    --success-color: #4CAF50;
    --danger-color: #EF5350;
    --warning-color: #FFCA28;

    --body-bg: #1a1a2e; /* Dark background */
    --card-bg: #2d2d44;
    --input-bg: #3a3a50;
    --border-color: #444;
    --shadow-color: rgba(0, 0, 0, 0.4);

    --text-color-primary: #f0f0f0;
    --text-color-secondary: #b0b0b0;
    --text-color-light: #777;

    --status-open-bg: #614a00;
    --status-open-text: #ffb74d;
    --status-in-progress-bg: #0d3b63;
    --status-in-progress-text: #81d4fa;
    --status-resolved-bg: #1b5e20;
    --status-resolved-text: #a5d6a7;
    --status-closed-bg: #37474f;
    --status-closed-text: #b0bec5;
}

/* --- Base Styles --- */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: var(--font-family-sans);
    font-size: var(--font-size-base);
    line-height: var(--line-height-base);
    color: var(--text-color-primary);
    background-color: var(--body-bg);
    transition: background-color var(--transition-speed), color var(--transition-speed);
}

#app {
    display: flex;
    min-height: 100vh;
    overflow: hidden; /* Prevent body scroll when nav is open on mobile */
}

/* --- Utility Classes --- */
.hidden {
    display: none !important;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* --- Navigation --- */
.main-nav {
    width: 280px;
    background-color: var(--card-bg);
    box-shadow: var(--shadow-elevation-2);
    display: flex;
    flex-direction: column;
    padding: var(--spacing-xl) var(--spacing-lg);
    border-right: 1px solid var(--border-color);
    flex-shrink: 0; /* Prevent shrinking */
    transition: width var(--transition-speed), background-color var(--transition-speed), border-color var(--transition-speed);
}

.nav-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xl);
}

.nav-brand {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary-color);
}

.menu-toggle {
    display: none; /* Hidden on desktop */
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-color-primary);
    cursor: pointer;
}


.nav-links {
    list-style: none;
    flex-grow: 1;
}

.nav-links li {
    margin-bottom: var(--spacing-sm);
}

.nav-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md) var(--spacing-lg);
    color: var(--text-color-secondary);
    text-decoration: none;
    border-radius: var(--border-radius-md);
    transition: background-color var(--transition-speed), color var(--transition-speed);
}

.nav-item:hover {
    background-color: var(--primary-light);
    color: var(--primary-color);
}

.nav-item.active-link {
    background-color: var(--primary-color);
    color: white;
    box-shadow: var(--shadow-elevation-1);
}

.nav-item.active-link:hover {
    background-color: var(--primary-dark);
    color: white;
}

.logout-btn {
    color: var(--danger-color);
}
.logout-btn:hover {
    background-color: rgba(var(--danger-color-rgb, 220, 53, 69), 0.1); /* Red tint */
    color: var(--danger-color);
}

.theme-switcher {
    margin-top: var(--spacing-xl);
    text-align: center;
}

#theme-toggle {
    font-size: 1.6rem;
    color: var(--text-color-secondary);
}
#theme-toggle:hover {
    color: var(--primary-color);
}


/* --- Main Content Area --- */
#main-content {
    flex-grow: 1;
    padding: var(--spacing-xl);
    overflow-y: auto; /* Enable scrolling for content */
    display: flex;
    flex-direction: column; /* Allows content to stack */
}

/* Section Transitions */
section {
    display: none;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.4s ease-out, transform 0.4s ease-out;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto; /* Center sections */
}

section.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

/* --- Buttons --- */
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: var(--border-radius-md);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background-color var(--transition-speed), transform 0.1s ease, box-shadow 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    white-space: nowrap; /* Prevent text wrap */
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-elevation-1);
}

.btn-secondary {
    background-color: var(--secondary-color);
    color: white;
}

.btn-secondary:hover {
    background-color: var(--secondary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-elevation-1);
}

.btn-info {
    background-color: var(--accent-color);
    color: white;
}
.btn-info:hover {
    background-color: #117a8b;
    transform: translateY(-2px);
}

.btn-danger {
    background-color: var(--danger-color);
    color: white;
}
.btn-danger:hover {
    background-color: #bd2130;
    transform: translateY(-2px);
}

.btn-outline-primary {
    background-color: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
}
.btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

.btn-outline-secondary {
    background-color: transparent;
    border: 1px solid var(--secondary-color);
    color: var(--secondary-color);
}
.btn-outline-secondary:hover {
    background-color: var(--secondary-color);
    color: white;
    transform: translateY(-2px);
}

.btn-icon {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: var(--text-color-secondary);
    padding: var(--spacing-xs);
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    transition: color var(--transition-speed);
}

.btn-icon:hover {
    color: var(--primary-color);
}

.btn-block {
    width: 100%;
    margin-top: var(--spacing-md);
}

.btn-back {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color-secondary);
    padding: 10px 20px;
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-elevation-1);
}
.btn-back:hover {
    background-color: var(--body-bg);
    color: var(--primary-color);
}


/* --- Cards / Panels --- */
.auth-card,
.modern-form,
.ticket-detail-card,
.profile-card,
.notification-settings,
.admin-panel {
    background-color: var(--card-bg);
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-elevation-2);
    transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
}

.ticket-detail-card, .admin-panel {
    padding: var(--spacing-xxl);
}

.modern-form.compact-form {
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}


/* --- Forms --- */
.form-group {
    margin-bottom: var(--spacing-md);
}

.form-group label {
    display: block;
    margin-bottom: var(--spacing-xs);
    font-weight: 500;
    color: var(--text-color-primary);
}

.form-group input[type="text"],
.form-group input[type="email"],
.form-group input[type="password"],
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    color: var(--text-color-primary);
    background-color: var(--input-bg);
    transition: border-color var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed);
}

.form-group input[type="text"]:focus,
.form-group input[type="email"]:focus,
.form-group input[type="password"]:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb, 0, 123, 255), 0.25);
}

.form-group textarea {
    resize: vertical;
    min-height: 120px;
}

.form-group input[type="file"] {
    border: 1px dashed var(--border-color);
    background-color: var(--input-bg);
    padding: var(--spacing-md);
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-color-secondary);
}
.form-group input[type="file"]::file-selector-button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    margin-right: var(--spacing-md);
    transition: background-color 0.2s ease;
}
.form-group input[type="file"]::file-selector-button:hover {
    background-color: var(--primary-dark);
}

.help-text {
    font-size: 0.85rem;
    color: var(--text-color-secondary);
    margin-top: var(--spacing-xs);
}

.required {
    color: var(--danger-color);
    margin-left: 2px;
}

.form-actions {
    display: flex;
    gap: var(--spacing-md);
    margin-top: var(--spacing-lg);
}

/* Error Messages for Forms */
.form-error-message {
    color: var(--danger-color);
    background-color: rgba(var(--danger-color-rgb, 220, 53, 69), 0.1);
    padding: var(--spacing-md);
    border-radius: var(--border-radius-md);
    margin-top: var(--spacing-md);
    text-align: center;
    font-size: 0.9rem;
    display: none;
}


/* --- Auth View --- */
.auth-view {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-grow: 1;
}

.auth-card {
    max-width: 450px;
    width: 100%;
    text-align: center;
}

.auth-title {
    font-size: 2rem;
    color: var(--primary-color);
    margin-bottom: var(--spacing-sm);
}

.auth-subtitle {
    font-size: 1.1rem;
    color: var(--text-color-secondary);
    margin-bottom: var(--spacing-xl);
}

.auth-tabs {
    display: flex;
    margin-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
}

.tab-button {
    flex-grow: 1;
    background: none;
    border: none;
    padding: 15px 0;
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--text-color-secondary);
    cursor: pointer;
    position: relative;
    transition: color var(--transition-speed);
}

.tab-button:hover {
    color: var(--primary-color);
}

.tab-button.active {
    color: var(--primary-color);
}

.tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -1px; /* Align with border */
    left: 0;
    width: 100%;
    height: 3px;
    background-color: var(--primary-color);
    border-radius: 2px 2px 0 0;
}

.auth-form {
    text-align: left;
}


/* --- Dashboard View --- */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.dashboard-header h1 {
    font-size: 1.8rem;
    color: var(--text-color-primary);
}
.dashboard-header h1 i {
    margin-right: var(--spacing-sm);
    color: var(--primary-color);
}


.dashboard-filters {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
    background-color: var(--card-bg);
    padding: var(--spacing-lg);
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-elevation-1);
}

.filter-group {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex-wrap: nowrap; /* Keep items in one line */
}

.filter-group label {
    font-weight: 500;
    color: var(--text-color-secondary);
    white-space: nowrap;
}
.filter-group label i {
    color: var(--primary-color);
    margin-right: 5px;
}

.filter-group select,
.filter-group input[type="text"] {
    padding: 10px 12px;
    border-radius: var(--border-radius-sm);
    font-size: 0.95rem;
}

.filter-group.search-group {
    flex-grow: 1; /* Allow search to take more space */
    min-width: 250px;
}
.filter-group.search-group input {
    flex-grow: 1;
}

.filter-group.checkbox-group label {
    cursor: pointer;
    display: flex;
    align-items: center;
}
.filter-group.checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: var(--spacing-sm);
    appearance: none;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s ease, border-color 0.2s ease;
}
.filter-group.checkbox-group input[type="checkbox"]:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}
.filter-group.checkbox-group input[type="checkbox"]:checked::after {
    content: '\2713'; /* Checkmark */
    color: white;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
}


.ticket-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

.ticket-card {
    background-color: var(--card-bg);
    padding: var(--spacing-lg);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-elevation-1);
    transition: transform 0.2s ease, box-shadow 0.2s ease, background-color var(--transition-speed);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    height: 100%; /* Ensure cards are same height in a row */
}

.ticket-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-elevation-2);
}

.ticket-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-sm);
    min-height: 48px; /* Ensure consistent header height */
}

.ticket-card-header h3 {
    font-size: 1.2rem;
    color: var(--primary-color);
    margin-bottom: 0;
    line-height: 1.4;
}

.ticket-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 80px;
}

.ticket-status.open {
    background-color: var(--status-open-bg);
    color: var(--status-open-text);
}

.ticket-status.in-progress {
    background-color: var(--status-in-progress-bg);
    color: var(--status-in-progress-text);
}

.ticket-status.resolved {
    background-color: var(--status-resolved-bg);
    color: var(--status-resolved-text);
}

.ticket-status.closed {
    background-color: var(--status-closed-bg);
    color: var(--status-closed-text);
}

.ticket-meta {
    font-size: 0.9rem;
    color: var(--text-color-secondary);
    margin-bottom: var(--spacing-sm);
}
.ticket-meta strong {
    color: var(--text-color-primary);
}

.tag-category {
    background-color: var(--primary-color);
    color: white;
    padding: 3px 8px;
    border-radius: var(--border-radius-sm);
    font-size: 0.75rem;
    margin-left: var(--spacing-sm);
    display: inline-block;
    vertical-align: middle;
}

.ticket-description-short {
    font-size: 0.95rem;
    color: var(--text-color-primary);
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3; /* Limit to 3 lines */
    -webkit-box-orient: vertical;
    margin-bottom: var(--spacing-md);
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-md);
    margin-top: var(--spacing-xl);
}

#page-info {
    font-weight: 500;
    color: var(--text-color-primary);
}


/* --- Skeleton Loading States --- */
@keyframes pulse-bg {
    0% { background-color: var(--border-color); }
    50% { background-color: var(--input-bg); }
    100% { background-color: var(--border-color); }
}

.skeleton {
    cursor: default !important;
}
.skeleton:hover {
    transform: none !important;
    box-shadow: var(--shadow-elevation-1) !important;
}

.skeleton-line {
    background-color: var(--border-color);
    height: 0.8rem;
    margin-bottom: 0.7rem;
    border-radius: 4px;
    animation: pulse-bg 1.5s infinite ease-in-out;
}
.skeleton-line.short { width: 40%; }
.skeleton-line.medium { width: 70%; }
.skeleton-line.long { width: 95%; }
.skeleton-line.tiny { width: 20%; }

/* Specific skeleton for ticket card */
.ticket-card.skeleton .skeleton-line:nth-child(1) { height: 1.3rem; width: 60%; margin-bottom: 1rem; } /* Subject */
.ticket-card.skeleton .skeleton-line:nth-child(2) { height: 0.9rem; width: 90%; } /* Meta */
.ticket-card.skeleton .skeleton-line:nth-child(3) { height: 0.9rem; width: 85%; } /* Desc line 1 */
.ticket-card.skeleton .skeleton-line:nth-child(4) { height: 0.9rem; width: 70%; } /* Desc line 2 */


/* Specific skeleton for user item in admin panel */
.user-item.skeleton-user {
    padding: var(--spacing-md);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}
.user-item.skeleton-user .skeleton-line { margin-bottom: 0; }
.user-item.skeleton-user .skeleton-line.short { width: 50%; }
.user-item.skeleton-user .skeleton-line.medium { width: 80%; }


/* --- Ticket Detail View --- */
.ticket-detail-view {
    max-width: 900px;
}

.ticket-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}

.ticket-detail-header h2 {
    font-size: 2rem;
    color: var(--primary-color);
    word-break: break-word;
}

.agent-meta {
    margin-top: -var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
}

.section-divider {
    border-top: 1px solid var(--border-color);
    margin: var(--spacing-xl) 0;
}

.ticket-description-full h3,
.conversation-timeline h3,
.add-comment-section h3 {
    font-size: 1.4rem;
    color: var(--text-color-primary);
    margin-bottom: var(--spacing-md);
}
.ticket-description-full h3 i,
.conversation-timeline h3 i,
.add-comment-section h3 i {
    margin-right: var(--spacing-sm);
    color: var(--primary-color);
}

.content-box {
    background-color: var(--input-bg);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    color: var(--text-color-primary);
    white-space: pre-wrap; /* Preserve whitespace and line breaks */
    word-wrap: break-word; /* Break long words */
    min-height: 80px;
    line-height: 1.8;
}

.attachments-list {
    margin-top: var(--spacing-md);
}
.attachments-list h4 {
    font-size: 1.1rem;
    margin-bottom: var(--spacing-sm);
    color: var(--text-color-primary);
}
.attachments-list .no-attachments {
    color: var(--text-color-secondary);
    font-style: italic;
}
.attachments-list .attachment-item {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    background-color: var(--body-bg);
    padding: 8px 12px;
    border-radius: var(--border-radius-sm);
    margin-right: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
    text-decoration: none;
    color: var(--primary-color);
    border: 1px solid var(--border-color);
    transition: background-color 0.2s ease, color 0.2s ease;
}
.attachments-list .attachment-item:hover {
    background-color: var(--primary-color);
    color: white;
}
.attachments-list .attachment-item i {
    font-size: 0.9em;
}


.ticket-actions-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap; /* Allow wrapping on smaller screens */
    gap: var(--spacing-md);
}

.vote-controls {
    display: flex;
    gap: var(--spacing-sm);
}
.vote-controls .vote-btn {
    font-size: 1rem;
    padding: 8px 15px;
}
.vote-controls .vote-btn i {
    margin-right: 5px;
}

.agent-actions {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}
.status-select {
    padding: 10px 15px;
    border-radius: var(--border-radius-md);
    border: 1px solid var(--border-color);
    background-color: var(--input-bg);
    color: var(--text-color-primary);
    font-size: 0.95rem;
}


.conversation-timeline .timeline-entries {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.timeline-entry {
    background-color: var(--primary-light); /* Differentiate messages */
    padding: var(--spacing-md);
    border-radius: var(--border-radius-md);
    border-left: 5px solid var(--primary-color);
    position: relative;
    padding-left: var(--spacing-xl); /* Make space for role indicator */
    transition: background-color var(--transition-speed), border-color var(--transition-speed);
}
body[data-theme='dark'] .timeline-entry {
    background-color: var(--input-bg);
    border-left-color: var(--primary-color);
}


.timeline-entry::before {
    content: '';
    position: absolute;
    left: var(--spacing-md);
    top: var(--spacing-md);
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background-color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
    text-transform: uppercase;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.timeline-entry.user-message::before {
    background-color: var(--primary-color);
    content: 'U';
}
.timeline-entry.agent-message::before {
    background-color: var(--accent-color);
    content: 'A';
}
.timeline-entry.system-message::before {
    background-color: var(--secondary-color);
    content: 'S';
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}

.timeline-author {
    font-weight: 600;
    color: var(--text-color-primary);
}

.timeline-date {
    font-size: 0.85rem;
    color: var(--text-color-secondary);
}

.timeline-content {
    color: var(--text-color-primary);
    line-height: 1.7;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.add-comment-section textarea {
    min-height: 100px;
    margin-bottom: var(--spacing-md);
}

/* Selected Files Preview (Create Ticket) */
.selected-files-preview {
    margin-top: var(--spacing-md);
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
}
.selected-files-preview .file-tag {
    background-color: var(--primary-light);
    color: var(--primary-color);
    padding: 6px 10px;
    border-radius: var(--border-radius-sm);
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}
.selected-files-preview .file-tag .remove-file {
    background: none;
    border: none;
    color: var(--danger-color);
    cursor: pointer;
    font-size: 1.1em;
}


/* --- Profile View --- */
.profile-view {
    max-width: 700px;
}

.profile-card, .notification-settings {
    margin-bottom: var(--spacing-xl);
}

.profile-info-display p {
    margin-bottom: var(--spacing-sm);
    color: var(--text-color-primary);
}
.profile-info-display strong {
    color: var(--primary-color);
}

.profile-actions {
    margin-top: var(--spacing-lg);
    border-top: 1px solid var(--border-color);
    padding-top: var(--spacing-lg);
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.notification-settings h3 {
    font-size: 1.4rem;
    margin-bottom: var(--spacing-md);
    color: var(--text-color-primary);
}

.switch-group {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--border-color);
}
.switch-group:last-child {
    border-bottom: none;
}
.switch-group label {
    font-weight: 500;
    color: var(--text-color-primary);
}

/* Toggle Switch (for notifications) */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border-color);
    transition: .4s;
    border-radius: 28px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary-color);
}

input:focus + .slider {
    box-shadow: 0 0 1px var(--primary-color);
}

input:checked + .slider:before {
    transform: translateX(22px);
}
input:disabled + .slider {
    opacity: 0.6;
    cursor: not-allowed;
}


/* --- Admin Panel --- */
.admin-view {
    max-width: 900px;
}

.admin-tabs {
    display: flex;
    margin-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
}

.admin-panel h3 {
    font-size: 1.4rem;
    margin-bottom: var(--spacing-lg);
    color: var(--text-color-primary);
}

.user-list-grid, .category-list-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--spacing-md);
}

.user-item {
    background-color: var(--body-bg);
    padding: var(--spacing-md);
    border-radius: var(--border-radius-md);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    transition: background-color var(--transition-speed), border-color var(--transition-speed);
}
.user-item:hover {
    background-color: var(--primary-light);
    border-color: var(--primary-color);
}
body[data-theme='dark'] .user-item:hover {
    background-color: var(--input-bg);
}

.user-info span {
    display: block;
    color: var(--text-color-primary);
}
.user-info .user-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--primary-color);
}
.user-info .user-email, .user-info .user-role {
    font-size: 0.9rem;
    color: var(--text-color-secondary);
}
.user-info .user-role {
    font-weight: 500;
    margin-top: 5px;
    padding: 3px 8px;
    background-color: var(--primary-light);
    border-radius: var(--border-radius-sm);
    display: inline-block;
}
body[data-theme='dark'] .user-info .user-role {
    background-color: var(--primary-dark);
    color: var(--primary-color);
}


.user-actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-sm);
}
.user-actions .btn {
    padding: 8px 12px;
    font-size: 0.9rem;
}

.category-item {
    background-color: var(--body-bg);
    padding: var(--spacing-md);
    border-radius: var(--border-radius-md);
    border: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color var(--transition-speed), border-color var(--transition-speed);
}
.category-item:hover {
    background-color: var(--primary-light);
    border-color: var(--primary-color);
}
body[data-theme='dark'] .category-item:hover {
    background-color: var(--input-bg);
}

.category-item span {
    font-weight: 500;
    color: var(--text-color-primary);
}


/* --- Modals --- */
.modal-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.modal-container.active {
    opacity: 1;
    pointer-events: auto;
}

.modal-content {
    background-color: var(--card-bg);
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-elevation-3);
    width: 90%;
    max-width: 500px;
    position: relative;
    transform: translateY(-20px) scale(0.95);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

.modal-container.active .modal-content {
    transform: translateY(0) scale(1);
    opacity: 1;
}

.modal-content h3 {
    font-size: 1.5rem;
    color: var(--primary-color);
    margin-bottom: var(--spacing-md);
}

.modal-content p {
    color: var(--text-color-primary);
    margin-bottom: var(--spacing-lg);
}
.modal-content p strong {
    color: var(--primary-color);
}

.close-button {
    position: absolute;
    top: var(--spacing-md);
    right: var(--spacing-md);
    background: none;
    border: none;
    font-size: 1.8rem;
    color: var(--text-color-secondary);
    cursor: pointer;
    line-height: 1;
}
.close-button:hover {
    color: var(--danger-color);
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-md);
    margin-top: var(--spacing-lg);
    border-top: 1px solid var(--border-color);
    padding-top: var(--spacing-md);
}

/* --- Toast Notifications --- */
.toast-container {
    position: fixed;
    bottom: var(--spacing-lg);
    right: var(--spacing-lg);
    z-index: 1001;
    display: flex;
    flex-direction: column-reverse; /* Newest toast on top */
    gap: var(--spacing-md);
    pointer-events: none; /* Allows clicks through to elements underneath */
}

.toast {
    background-color: var(--card-bg);
    color: var(--text-color-primary);
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-elevation-2);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    min-width: 250px;
    max-width: 350px;
    transform: translateX(100%);
    opacity: 0;
    animation: slideInToast 0.4s ease-out forwards, fadeOutToast 0.4s ease-out forwards var(--toast-delay, 3s);
    pointer-events: auto; /* Re-enable pointer events for the toast itself */
}

.toast.success {
    border-left: 5px solid var(--success-color);
}
.toast.error {
    border-left: 5px solid var(--danger-color);
}
.toast.info {
    border-left: 5px solid var(--accent-color);
}

.toast-icon {
    font-size: 1.4rem;
}
.toast.success .toast-icon { color: var(--success-color); }
.toast.error .toast-icon { color: var(--danger-color); }
.toast.info .toast-icon { color: var(--accent-color); }

.toast-message {
    flex-grow: 1;
    font-size: 0.95rem;
}

@keyframes slideInToast {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeOutToast {
    from { opacity: 1; }
    to { opacity: 0; transform: translateX(100%); }
}


/* --- Responsive Design --- */
@media (max-width: 1024px) {
    #main-content {
        padding: var(--spacing-lg);
    }
    .ticket-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
}

@media (max-width: 768px) {
    #app {
        flex-direction: column;
    }

    .main-nav {
        width: 100%;
        padding: var(--spacing-md);
        box-shadow: 0 2px 10px var(--shadow-color);
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        flex-direction: row; /* Horizontal layout for nav header */
        justify-content: space-between;
        align-items: center;
    }

    .nav-header {
        margin-bottom: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .nav-brand {
        font-size: 1.6rem;
    }

    .menu-toggle {
        display: block; /* Show hamburger icon */
    }

    .nav-links {
        display: none; /* Hide nav links by default */
        position: absolute;
        top: 60px; /* Adjust based on nav height */
        left: 0;
        width: 100%;
        background-color: var(--card-bg);
        box-shadow: 0 4px 10px var(--shadow-color);
        padding: var(--spacing-md);
        z-index: 100;
        flex-direction: column;
    }
    .main-nav.menu-open .nav-links {
        display: flex; /* Show when menu is open */
    }

    .theme-switcher {
        margin-top: 0;
        margin-left: var(--spacing-md); /* Space from brand/toggle */
    }

    #main-content {
        padding: var(--spacing-md);
    }

    .dashboard-filters {
        flex-direction: column;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
    }

    .filter-group {
        width: 100%;
        justify-content: space-between;
    }

    .filter-group select,
    .filter-group input[type="text"] {
        flex-grow: 1;
    }
    .filter-group.search-group {
        min-width: unset;
    }

    .auth-card,
    .modern-form,
    .ticket-detail-card,
    .profile-card,
    .admin-panel {
        padding: var(--spacing-md);
    }

    .ticket-detail-header h2 {
        font-size: 1.5rem;
    }

    .ticket-actions-row {
        flex-direction: column;
        align-items: flex-start;
    }
    .agent-actions {
        width: 100%;
        justify-content: flex-start;
    }
    .agent-actions .btn, .agent-actions select {
        width: auto;
        flex-grow: 1;
    }
    .add-comment-section .btn {
        width: 100%;
    }

    .modal-content {
        padding: var(--spacing-lg);
    }
    .modal-actions {
        flex-direction: column;
    }
    .modal-actions .btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-md);
    }
    .dashboard-header .btn {
        width: 100%;
    }
    .filter-group {
        flex-direction: column;
        align-items: flex-start;
    }
    .filter-group label {
        width: 100%;
        margin-bottom: 5px;
    }
    .filter-group select, .filter-group input[type="text"] {
        width: 100%;
    }
    .filter-group.checkbox-group label {
        flex-direction: row;
    }

    .auth-title {
        font-size: 1.6rem;
    }
    .auth-subtitle {
        font-size: 1rem;
    }

    .tab-button {
        font-size: 1rem;
        padding: 12px 0;
    }

    .toast {
        min-width: unset;
        width: calc(100% - var(--spacing-xl) * 2);
        left: var(--spacing-lg);
        right: var(--spacing-lg);
    }
}

    </style>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="app" class="app-container">
        <nav id="main-nav" class="main-nav hidden">
            <div class="nav-header">
                <span class="nav-brand">QuickDesk</span>
                <button class="menu-toggle" aria-label="Toggle navigation menu">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <ul class="nav-links">
                <li><a href="#" data-nav-target="dashboard" class="nav-item active-link"><i class="fas fa-th-large"></i> Dashboard</a></li>
                <li><a href="#" data-nav-target="create-ticket" class="nav-item"><i class="fas fa-plus-circle"></i> Create Ticket</a></li>
                <li><a href="#" data-nav-target="profile" class="nav-item"><i class="fas fa-user-circle"></i> Profile</a></li>
                <li id="admin-nav-item" class="hidden"><a href="#" data-nav-target="admin" class="nav-item"><i class="fas fa-user-shield"></i> Admin Panel</a></li>
                <li><a href="#" id="logout-btn" class="nav-item logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
            <div class="theme-switcher">
                <button id="theme-toggle" class="btn-icon" title="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </nav>

        <main id="main-content">
            <section id="auth-view" class="auth-view active">
                <div class="auth-card">
                    <h2 class="auth-title">Welcome to QuickDesk</h2>
                    <p class="auth-subtitle">Your efficient support solution.</p>

                    <div class="auth-tabs">
                        <button class="tab-button active" data-tab="login">Login</button>
                        <button class="tab-button" data-tab="register">Register</button>
                    </div>

                    <form id="login-form" class="auth-form active">
                        <div class="form-group">
                            <label for="login-email">Email Address</label>
                            <input type="email" id="login-email" placeholder="john.doe@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" placeholder="********" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Sign In</button>
                    </form>

                    <form id="register-form" class="auth-form hidden">
                        <div class="form-group">
                            <label for="register-name">Full Name</label>
                            <input type="text" id="register-name" placeholder="John Doe" required>
                        </div>
                        <div class="form-group">
                            <label for="register-email">Email Address</label>
                            <input type="email" id="register-email" placeholder="john.doe@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password">Password</label>
                            <input type="password" id="register-password" placeholder="********" required>
                            <p class="help-text">Min 6 characters. Consider a strong password.</p>
                        </div>
                        <div class="form-group">
                            <label for="register-role">Register As</label>
                            <select id="register-role" required>
                                <option value="user">End User (Employee/Customer)</option>
                                <option value="agent">Support Agent</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Create Account</button>
                    </form>
                    <p class="form-error-message" id="auth-error"></p>
                </div>
            </section>

            <section id="dashboard-view" class="dashboard-view hidden">
                <div class="dashboard-header">
                    <h1><i class="fas fa-clipboard-list"></i> My Tickets Overview</h1>
                    <button class="btn btn-primary" data-nav-target="create-ticket"><i class="fas fa-plus-circle"></i> Create New Ticket</button>
                </div>

                <div class="dashboard-filters">
                    <div class="filter-group">
                        <label for="status-filter"><i class="fas fa-info-circle"></i> Status:</label>
                        <select id="status-filter">
                            <option value="all">All</option>
                            <option value="open">Open</option>
                            <option value="in-progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="category-filter"><i class="fas fa-tag"></i> Category:</label>
                        <select id="category-filter">
                            <option value="all">All</option>
                            </select>
                    </div>
                    <div class="filter-group checkbox-group">
                        <input type="checkbox" id="my-tickets-filter">
                        <label for="my-tickets-filter">Only My Tickets</label>
                    </div>
                    <div class="filter-group search-group">
                        <input type="text" id="search-tickets" placeholder="Search by subject or description...">
                        <button class="btn btn-primary btn-icon"><i class="fas fa-search"></i></button>
                    </div>
                    <div class="filter-group sort-group">
                        <label for="sort-by"><i class="fas fa-sort"></i> Sort By:</label>
                        <select id="sort-by">
                            <option value="recent">Recently Modified</option>
                            <option value="replies">Most Replied</option>
                        </select>
                    </div>
                </div>

                <div class="ticket-grid" id="ticket-grid">
                    <div class="ticket-card skeleton">
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line medium"></div>
                    </div>
                    <div class="ticket-card skeleton">
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line medium"></div>
                    </div>
                    <div class="ticket-card skeleton">
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line medium"></div>
                    </div>
                </div>

                <div class="pagination">
                    <button class="btn btn-secondary" id="prev-page" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                    <span id="page-info">Page 1 of 1</span>
                    <button class="btn btn-secondary" id="next-page" disabled>Next <i class="fas fa-chevron-right"></i></button>
                </div>
            </section>

            <section id="create-ticket-view" class="create-ticket-view hidden">
                <h2><i class="fas fa-ticket-alt"></i> Submit a New Support Ticket</h2>
                <form id="create-ticket-form" action="/ticket/create" method="POST" class="modern-form">
                    <div class="form-group">
                        <label for="ticket-subject">Subject <span class="required">*</span></label>
                        <input type="text" id="ticket-subject" placeholder="Concise summary of your issue" required>
                    </div>
                    <div class="form-group">
                        <label for="ticket-description">Detailed Description <span class="required">*</span></label>
                        <textarea id="ticket-description" rows="10" placeholder="Provide all relevant details: what, when, how it happened, steps to reproduce, error messages, etc." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="ticket-category">Category <span class="required">*</span></label>
                        <select id="ticket-category" required>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="ticket-attachment">Attachments (Optional)</label>
                        <input type="file" id="ticket-attachment" multiple accept="image/*,.pdf,.doc,.docx">
                        <p class="help-text">Max 5 files, 5MB each. Allowed types: Images, PDFs, Word documents.</p>
                        <div id="selected-files" class="selected-files-preview"></div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Ticket</button>
                        <button type="button" class="btn btn-secondary" data-nav-target="dashboard"><i class="fas fa-times"></i> Cancel</button>
                    </div>
                    <p class="form-error-message" id="create-ticket-error"></p>
                </form>
            </section>

            <section id="ticket-detail-view" class="ticket-detail-view hidden">
                <button class="btn btn-back" data-nav-target="dashboard"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
                <div class="ticket-detail-card">
                    <div class="ticket-detail-header">
                        <h2 id="detail-subject"></h2>
                        <span class="ticket-status" id="detail-status"></span>
                    </div>
                    <p class="ticket-meta">
                        Raised by: <strong id="detail-raised-by"></strong> on <span id="detail-date"></span>
                        <span id="detail-category" class="tag-category"></span>
                    </p>
                    <p class="ticket-meta agent-meta">
                        Assigned to: <strong id="detail-assigned-to">N/A</strong>
                    </p>

                    <div class="section-divider"></div>

                    <div class="ticket-description-full">
                        <h3><i class="fas fa-file-alt"></i> Description</h3>
                        <div id="detail-description" class="content-box"></div>
                        <div id="detail-attachments" class="attachments-list">
                            <h4><i class="fas fa-paperclip"></i> Attachments</h4>
                            <p class="no-attachments">No attachments.</p>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="ticket-actions-row">
                        <div class="vote-controls">
                            <button class="btn btn-outline-primary vote-btn" id="upvote-btn" title="Upvote"><i class="fas fa-thumbs-up"></i> <span id="upvote-count">0</span></button>
                            <button class="btn btn-outline-secondary vote-btn" id="downvote-btn" title="Downvote"><i class="fas fa-thumbs-down"></i> <span id="downvote-count">0</span></button>
                        </div>
                        <div class="agent-actions hidden" id="agent-actions-section">
                            <button class="btn btn-info" id="assign-ticket-btn"><i class="fas fa-user-tag"></i> Assign to Me</button>
                            <select id="agent-status-update" class="status-select">
                                <option value="">Update Status</option>
                                <option value="open">Open</option>
                                <option value="in-progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="conversation-timeline" id="conversation-timeline">
                        <h3><i class="fas fa-comments"></i> Conversation History</h3>
                        <div class="timeline-entries">
                            </div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="add-comment-section">
                        <h3><i class="fas fa-comment-dots"></i> Add Comment / Update</h3>
                        <textarea id="comment-text" rows="5" placeholder="Type your comment or update here..."></textarea>
                        <button class="btn btn-primary" id="add-comment-btn"><i class="fas fa-reply"></i> Post Comment</button>
                    </div>
                </div>
            </section>

            <section id="profile-view" class="profile-view hidden">
                <h2><i class="fas fa-user-circle"></i> Profile & Settings</h2>
                <div class="profile-card modern-form">
                    <h3>Your Information</h3>
                    <div class="profile-info-display">
                        <p><strong>Name:</strong> <span id="profile-name"></span></p>
                        <p><strong>Email:</strong> <span id="profile-email"></span></p>
                        <p><strong>Role:</strong> <span id="profile-role"></span></p>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-secondary"><i class="fas fa-edit"></i> Edit Profile</button>
                        <button class="btn btn-secondary"><i class="fas fa-key"></i> Change Password</button>
                    </div>
                </div>
                <div class="notification-settings modern-form">
                    <h3><i class="fas fa-bell"></i> Notification Preferences</h3>
                    <div class="form-group switch-group">
                        <label for="email-notifications">Email Notifications</label>
                        <label class="switch">
                            <input type="checkbox" id="email-notifications" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="form-group switch-group">
                        <label for="push-notifications">In-app Notifications (Coming Soon)</label>
                        <label class="switch">
                            <input type="checkbox" id="push-notifications" disabled>
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </section>

            <section id="admin-view" class="admin-view hidden">
                <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                <div class="admin-tabs">
                    <button class="tab-button active" data-admin-tab="user-management"><i class="fas fa-users"></i> User Management</button>
                    <button class="tab-button" data-admin-tab="category-management"><i class="fas fa-tags"></i> Category Management</button>
                </div>

                <div id="user-management-panel" class="admin-panel active">
                    <h3>Registered Users</h3>
                    <div class="user-list-grid" id="user-list-grid">
                        <div class="user-item skeleton-user">
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line medium"></div>
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line tiny"></div>
                        </div>
                        <div class="user-item skeleton-user">
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line medium"></div>
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line tiny"></div>
                        </div>
                    </div>
                </div>

                <div id="category-management-panel" class="admin-panel hidden">
                    <h3>Manage Ticket Categories</h3>
                    <form id="add-category-form" class="modern-form compact-form">
                        <div class="form-group">
                            <label for="new-category-name">New Category Name</label>
                            <input type="text" id="new-category-name" placeholder="e.g., Network Issues" required>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add Category</button>
                    </form>
                    <div class="category-list-grid" id="category-list-grid">
                        </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-container" class="modal-container hidden">
        <div id="edit-role-modal" class="modal-content hidden">
            <button class="close-button" data-modal-close>&times;</button>
            <h3>Edit User Role</h3>
            <p>User: <strong id="modal-user-name"></strong> (<span id="modal-user-email"></span>)</p>
            <div class="form-group">
                <label for="modal-user-role">New Role</label>
                <select id="modal-user-role">
                    <option value="user">End User</option>
                    <option value="agent">Support Agent</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="save-role-btn">Save Changes</button>
                <button class="btn btn-secondary" data-modal-close>Cancel</button>
            </div>
        </div>

        <div id="confirmation-modal" class="modal-content hidden">
            <button class="close-button" data-modal-close>&times;</button>
            <h3 id="confirmation-title">Confirm Action</h3>
            <p id="confirmation-message">Are you sure you want to proceed?</p>
            <div class="modal-actions">
                <button class="btn btn-danger" id="confirm-action-btn">Confirm</button>
                <button class="btn btn-secondary" data-modal-close>Cancel</button>
            </div>
        </div>

        </div>

    <div id="toast-container" class="toast-container">
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
    // --- Global DOM Elements ---
    const appContainer = document.getElementById('app');
    const mainNav = document.getElementById('main-nav');
    const mainContent = document.getElementById('main-content');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const logoutBtn = document.getElementById('logout-btn');
    const menuToggle = document.querySelector('.menu-toggle');
    const adminNavItem = document.getElementById('admin-nav-item');

    // Views
    const views = {
        auth: document.getElementById('auth-view'),
        dashboard: document.getElementById('dashboard-view'),
        createTicket: document.getElementById('create-ticket-view'),
        ticketDetail: document.getElementById('ticket-detail-view'),
        profile: document.getElementById('profile-view'),
        admin: document.getElementById('admin-view')
    };

    // Modals
    const modalContainer = document.getElementById('modal-container');
    const editRoleModal = document.getElementById('edit-role-modal');
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalUserName = document.getElementById('modal-user-name');
    const modalUserEmail = document.getElementById('modal-user-email');
    const modalUserRole = document.getElementById('modal-user-role');
    const saveRoleBtn = document.getElementById('save-role-btn');
    const confirmationTitle = document.getElementById('confirmation-title');
    const confirmationMessage = document.getElementById('confirmation-message');
    const confirmActionBtn = document.getElementById('confirm-action-btn');

    // Profile Modals (New)
    const editProfileModal = document.getElementById('edit-profile-modal'); // Assuming you'll add these in HTML
    const changePasswordModal = document.getElementById('change-password-modal'); // Assuming you'll add these in HTML

    const toastContainer = document.getElementById('toast-container');

    // --- Simulated Backend Data (LocalStorage) ---
    // Initialize data if not present
    let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
    let users = JSON.parse(localStorage.getItem('users')) || [];
    let tickets = JSON.parse(localStorage.getItem('tickets')) || [];
    let categories = JSON.parse(localStorage.getItem('categories')) || ['Technical', 'Billing', 'Feature Request', 'General Inquiry', 'Hardware Support'];

    // Add a default admin if none exists for easy testing
    if (!users.some(u => u.role === 'admin')) {
        users.push({
            id: 1,
            name: 'Admin User',
            email: 'admin@quickdesk.com',
            password: 'password', // In a real app, hash this!
            role: 'admin',
            createdAt: new Date().toISOString()
        });
        localStorage.setItem('users', JSON.stringify(users));
    }
    // Add a default agent if none exists
    if (!users.some(u => u.role === 'agent')) {
        users.push({
            id: 2,
            name: 'Support Agent',
            email: 'agent@quickdesk.com',
            password: 'password',
            role: 'agent',
            createdAt: new Date().toISOString()
        });
        localStorage.setItem('users', JSON.stringify(users));
    }
    // Ensure categories are always saved
    localStorage.setItem('categories', JSON.stringify(categories));


    let currentFilters = {
        status: 'all',
        category: 'all',
        myTickets: false,
        search: '',
        sortBy: 'recent', // 'recent' or 'replies'
        page: 1,
        itemsPerPage: 6
    };
    let activeTicketId = null; // Currently viewed ticket ID

    // --- Helper Functions ---

    function saveState() {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('tickets', JSON.stringify(tickets));
        localStorage.setItem('categories', JSON.stringify(categories));
    }

    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.classList.add('toast', type);
        const iconClass = {
            'info': 'fas fa-info-circle',
            'success': 'fas fa-check-circle',
            'error': 'fas fa-times-circle',
            'warning': 'fas fa-exclamation-triangle'
        }[type];
        toast.innerHTML = `
            <i class="toast-icon ${iconClass}"></i>
            <span class="toast-message">${message}</span>
        `;
        toast.style.setProperty('--toast-delay', `${duration / 1000}s`);
        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, duration + 400); // 400ms for fadeOutToast animation
    }

    function showModal(modalElement) {
        modalContainer.classList.add('active');
        // Hide all modals first, then show the desired one
        document.querySelectorAll('.modal-content').forEach(modal => {
            modal.classList.add('hidden');
            modal.classList.remove('active');
        });
        modalElement.classList.remove('hidden');
        modalElement.classList.add('active'); // For animation
    }

    function hideModal() {
        modalContainer.classList.remove('active');
        document.querySelectorAll('.modal-content').forEach(modal => {
            modal.classList.add('hidden');
            modal.classList.remove('active');
        });
    }

    function showConfirmation(title, message, onConfirmCallback) {
        confirmationTitle.textContent = title;
        confirmationMessage.textContent = message;
        // Clone and re-add to clear previous listeners
        const oldConfirmBtn = confirmActionBtn;
        const newConfirmBtn = oldConfirmBtn.cloneNode(true);
        oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn);
        newConfirmBtn.onclick = () => {
            onConfirmCallback();
            hideModal();
        };
        confirmActionBtn = newConfirmBtn; // Update the reference
        showModal(confirmationModal);
    }


    function switchView(viewElement) {
        Object.values(views).forEach(view => {
            view.classList.remove('active');
            view.classList.add('hidden');
        });
        viewElement.classList.remove('hidden');
        viewElement.classList.add('active');

        // Update active link in navigation
        document.querySelectorAll('.nav-links .nav-item').forEach(link => {
            link.classList.remove('active-link');
            if (link.dataset.navTarget && viewElement.id.startsWith(link.dataset.navTarget)) {
                link.classList.add('active-link');
            }
        });

        // Close mobile nav if open
        mainNav.classList.remove('menu-open');
        mainContent.scrollTop = 0; // Scroll to top of content when changing view
    }

    function updateNavVisibility() {
        if (currentUser) {
            mainNav.classList.remove('hidden');
            if (currentUser.role === 'admin') {
                adminNavItem.classList.remove('hidden');
            } else {
                adminNavItem.classList.add('hidden');
            }
        } else {
            mainNav.classList.add('hidden');
        }
    }

    function displayFormError(element, message) {
        element.textContent = message;
        element.style.display = 'block';
        setTimeout(() => {
            element.style.display = 'none';
        }, 3000);
    }

    function populateCategoryDropdowns() {
        const dropdowns = [
            document.getElementById('category-filter'),
            document.getElementById('ticket-category')
        ];

        dropdowns.forEach(dropdown => {
            // Clear existing options, but keep 'All' for filter
            if (dropdown.id === 'category-filter') {
                dropdown.innerHTML = '<option value="all">All Categories</option>';
            } else {
                dropdown.innerHTML = '<option value="">Select Category</option>'; // Placeholder for create ticket form
            }

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.toLowerCase().replace(/\s/g, '-');
                option.textContent = cat;
                dropdown.appendChild(option);
            });
        });
    }

    // --- UI Rendering Functions ---

    function renderTickets() {
        const ticketGrid = document.getElementById('ticket-grid');
        ticketGrid.innerHTML = ''; // Clear existing tickets

        // Show skeletons while "loading"
        for (let i = 0; i < currentFilters.itemsPerPage; i++) {
            const skeletonCard = document.createElement('div');
            skeletonCard.classList.add('ticket-card', 'skeleton');
            skeletonCard.innerHTML = `
                <div class="skeleton-line short"></div>
                <div class="skeleton-line medium"></div>
                <div class="skeleton-line long"></div>
                <div class="skeleton-line medium"></div>
            `;
            ticketGrid.appendChild(skeletonCard);
        }

        setTimeout(() => { // Simulate API delay
            const filteredTickets = tickets.filter(ticket => {
                const matchesStatus = currentFilters.status === 'all' || ticket.status.toLowerCase().replace(/\s/g, '-') === currentFilters.status;
                const matchesCategory = currentFilters.category === 'all' || ticket.category.toLowerCase().replace(/\s/g, '-') === currentFilters.category;
                const matchesMyTickets = !currentFilters.myTickets || ticket.userId === currentUser.id;
                const matchesSearch = ticket.subject.toLowerCase().includes(currentFilters.search.toLowerCase()) ||
                                      ticket.description.toLowerCase().includes(currentFilters.search.toLowerCase());
                return matchesStatus && matchesCategory && matchesMyTickets && matchesSearch;
            });

            // Sorting
            filteredTickets.sort((a, b) => {
                if (currentFilters.sortBy === 'recent') {
                    return new Date(b.lastModified) - new Date(a.lastModified);
                } else if (currentFilters.sortBy === 'replies') {
                    return (b.comments?.length || 0) - (a.comments?.length || 0);
                }
                return 0;
            });

            const totalPages = Math.ceil(filteredTickets.length / currentFilters.itemsPerPage);
            currentFilters.page = Math.min(currentFilters.page, Math.max(1, totalPages)); // Ensure page is valid
            document.getElementById('page-info').textContent = `Page ${currentFilters.page} of ${Math.max(1, totalPages)}`;

            document.getElementById('prev-page').disabled = currentFilters.page === 1;
            document.getElementById('next-page').disabled = currentFilters.page >= totalPages;

            const startIndex = (currentFilters.page - 1) * currentFilters.itemsPerPage;
            const endIndex = startIndex + currentFilters.itemsPerPage;
            const paginatedTickets = filteredTickets.slice(startIndex, endIndex);

            ticketGrid.innerHTML = ''; // Clear skeletons and prepare for actual content

            if (paginatedTickets.length === 0) {
                ticketGrid.innerHTML = '<p class="no-results">No tickets found matching your criteria.</p>';
                return;
            }

            paginatedTickets.forEach(ticket => {
                const ticketCard = document.createElement('div');
                ticketCard.classList.add('ticket-card');
                ticketCard.dataset.id = ticket.id;

                const user = users.find(u => u.id === ticket.userId);

                ticketCard.innerHTML = `
                    <div class="ticket-card-header">
                        <h3>${ticket.subject}</h3>
                        <span class="ticket-status ${ticket.status.toLowerCase().replace(/\s/g, '-')}">${ticket.status}</span>
                    </div>
                    <p class="ticket-meta">
                        Raised by: <strong>${user ? user.name : 'N/A'}</strong> on ${new Date(ticket.createdAt).toLocaleDateString()}
                    </p>
                    <p class="ticket-meta">Category: <span class="tag-category">${ticket.category}</span></p>
                    <p class="ticket-description-short">${ticket.description}</p>
                `;
                ticketGrid.appendChild(ticketCard);
            });
        }, 500); // Simulate network delay
    }

    function renderTicketDetail(ticketId) {
        const ticket = tickets.find(t => t.id === ticketId);
        if (!ticket) {
            showToast('Ticket not found!', 'error');
            switchView(views.dashboard);
            return;
        }

        const user = users.find(u => u.id === ticket.userId);
        const agent = ticket.assignedTo ? users.find(u => u.id === ticket.assignedTo) : null;

        document.getElementById('detail-subject').textContent = ticket.subject;
        document.getElementById('detail-status').className = `ticket-status ${ticket.status.toLowerCase().replace(/\s/g, '-')} ${ticket.status.toLowerCase()}`; // Add specific status class
        document.getElementById('detail-status').textContent = ticket.status;
        document.getElementById('detail-raised-by').textContent = user ? user.name : 'N/A';
        document.getElementById('detail-date').textContent = new Date(ticket.createdAt).toLocaleString();
        document.getElementById('detail-category').textContent = ticket.category;
        document.getElementById('detail-description').textContent = ticket.description;
        document.getElementById('detail-assigned-to').textContent = agent ? agent.name : 'N/A';


        // Attachments
        const attachmentsList = document.getElementById('detail-attachments');
        attachmentsList.innerHTML = '<h4><i class="fas fa-paperclip"></i> Attachments</h4>';
        if (ticket.attachments && ticket.attachments.length > 0) {
            const attachmentContainer = document.createElement('div');
            attachmentContainer.classList.add('attachment-items');
            ticket.attachments.forEach((file, index) => {
                // For a real app, this would be a secure download link from your server.
                // Here, it's a dummy link or a Blob URL if the file content was actually saved.
                const fileName = file.name || `attachment-${index + 1}`;
                const fileSize = file.size ? `(${(file.size / 1024 / 1024).toFixed(2)} MB)` : '';
                const link = document.createElement('a');
                link.href = '#'; // Dummy href
                link.classList.add('attachment-item');
                link.innerHTML = `<i class="fas fa-file"></i> ${fileName} ${fileSize}`;
                link.title = `Download ${fileName}`;
                // In a real app, link.href would be the actual download URL
                attachmentContainer.appendChild(link);
            });
            attachmentsList.appendChild(attachmentContainer);
        } else {
            attachmentsList.innerHTML += '<p class="no-attachments">No attachments.</p>';
        }

        // Upvote/Downvote
        document.getElementById('upvote-count').textContent = ticket.upvotes || 0;
        document.getElementById('downvote-count').textContent = ticket.downvotes || 0;
        document.getElementById('upvote-btn').dataset.ticketId = ticket.id;
        document.getElementById('downvote-btn').dataset.ticketId = ticket.id;

        // Agent Actions
        const agentActionsSection = document.getElementById('agent-actions-section');
        const assignTicketBtn = document.getElementById('assign-ticket-btn');
        const agentStatusUpdate = document.getElementById('agent-status-update');

        if (currentUser.role === 'agent') {
            agentActionsSection.classList.remove('hidden');
            assignTicketBtn.dataset.ticketId = ticket.id;
            assignTicketBtn.textContent = ticket.assignedTo === currentUser.id ? 'Assigned to You' : (ticket.assignedTo ? `Assigned to ${agent.name}` : 'Assign to Me');
            assignTicketBtn.disabled = !!ticket.assignedTo; // Disable if already assigned
            assignTicketBtn.classList.toggle('btn-secondary', !ticket.assignedTo); // Change style if disabled/assigned
            assignTicketBtn.classList.toggle('btn-info', !!ticket.assignedTo);


            agentStatusUpdate.value = ticket.status.toLowerCase().replace(/\s/g, '-');
            agentStatusUpdate.dataset.ticketId = ticket.id; // Set data-id for event delegation
        } else {
            agentActionsSection.classList.add('hidden');
        }

        // Conversation Timeline
        const conversationTimelineEntries = document.querySelector('#conversation-timeline .timeline-entries');
        conversationTimelineEntries.innerHTML = '';
        if (ticket.comments && ticket.comments.length > 0) {
            ticket.comments.forEach(comment => {
                const commentUser = users.find(u => u.id === comment.userId);
                const entry = document.createElement('div');
                entry.classList.add('timeline-entry', `${comment.role}-message`); // Use comment.role for styling
                entry.innerHTML = `
                    <div class="timeline-header">
                        <span class="timeline-author">${commentUser ? commentUser.name : 'N/A'}</span>
                        <span class="timeline-date">${new Date(comment.timestamp).toLocaleString()}</span>
                    </div>
                    <p class="timeline-content">${comment.text}</p>
                `;
                conversationTimelineEntries.appendChild(entry);
            });
        } else {
            conversationTimelineEntries.innerHTML = '<p class="no-results">No comments yet. Be the first to add one!</p>';
        }

        // Add Comment Section
        document.getElementById('comment-text').value = '';
        document.getElementById('add-comment-btn').dataset.ticketId = ticket.id;
        const commentInput = document.getElementById('comment-text');
        const addCommentButton = document.getElementById('add-comment-btn');

        if (currentUser.role === 'user' && ticket.userId !== currentUser.id) {
            commentInput.disabled = true;
            addCommentButton.disabled = true;
            commentInput.placeholder = "You can only comment on your own tickets.";
        } else {
            commentInput.disabled = false;
            addCommentButton.disabled = false;
            commentInput.placeholder = "Type your comment or update here...";
        }

        switchView(views.ticketDetail);
    }

    function renderUserManagement() {
        const userListGrid = document.getElementById('user-list-grid');
        userListGrid.innerHTML = ''; // Clear existing users

        // Show skeletons while "loading"
        for (let i = 0; i < 6; i++) { // Show 6 skeleton users
            const skeletonUser = document.createElement('div');
            skeletonUser.classList.add('user-item', 'skeleton-user');
            skeletonUser.innerHTML = `
                <div class="skeleton-line short"></div>
                <div class="skeleton-line medium"></div>
                <div class="skeleton-line short"></div>
                <div class="skeleton-line tiny"></div>
            `;
            userListGrid.appendChild(skeletonUser);
        }

        setTimeout(() => { // Simulate API delay
            userListGrid.innerHTML = ''; // Clear skeletons
            if (users.length === 0) {
                userListGrid.innerHTML = '<p class="no-results">No users registered.</p>';
                return;
            }

            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.classList.add('user-item');
                userItem.dataset.id = user.id; // Store user ID

                userItem.innerHTML = `
                    <div class="user-info">
                        <span class="user-name">${user.name}</span>
                        <span class="user-email">${user.email}</span>
                        <span class="user-role">${user.role}</span>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-secondary btn-sm" data-action="edit-role" data-user-id="${user.id}"><i class="fas fa-edit"></i> Edit Role</button>
                        <button class="btn btn-danger btn-sm" data-action="delete-user" data-user-id="${user.id}" ${user.id === currentUser.id ? 'disabled' : ''}><i class="fas fa-trash-alt"></i> Delete</button>
                    </div>
                `;
                userListGrid.appendChild(userItem);
            });
        }, 500);
    }

    function renderCategoryManagement() {
        const categoryListGrid = document.getElementById('category-list-grid');
        categoryListGrid.innerHTML = '';

        if (categories.length === 0) {
            categoryListGrid.innerHTML = '<p class="no-results">No categories defined.</p>';
            return;
        }

        categories.forEach(category => {
            const categoryItem = document.createElement('div');
            categoryItem.classList.add('category-item');
            categoryItem.innerHTML = `
                <span>${category}</span>
                <div class="category-actions">
                    <button class="btn btn-danger btn-sm" data-action="delete-category" data-category-name="${category}"><i class="fas fa-trash-alt"></i> Delete</button>
                </div>
            `;
            categoryListGrid.appendChild(categoryItem);
        });
    }

    // --- Core Logic Functions (Simulating Backend Interaction) ---

    function handleLogin(email, password) {
        const user = users.find(u => u.email === email && u.password === password);
        if (user) {
            currentUser = user;
            saveState();
            updateNavVisibility();
            populateCategoryDropdowns();
            renderTickets();
            switchView(views.dashboard);
            showToast(`Welcome back, ${currentUser.name}!`, 'success');
        } else {
            displayFormError(document.getElementById('auth-error'), 'Invalid email or password. Please try again.');
        }
    }

    function handleRegister(name, email, password, role) {
        if (users.some(u => u.email === email)) {
            displayFormError(document.getElementById('auth-error'), 'Email already registered. Please login or use a different email.');
            return;
        }
        const newUser = {
            id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
            name,
            email,
            password, // In real app: hash this!
            role,
            createdAt: new Date().toISOString()
        };
        users.push(newUser);
        saveState();
        showToast('Account created successfully! Please log in.', 'success');
        // Switch to login tab
        document.querySelector('.auth-tabs .tab-button[data-tab="login"]').click(); // Correct tab selection
        document.getElementById('login-email').value = email;
        document.getElementById('login-password').value = password;
    }

    function handleCreateTicket(subject, description, category, attachments) {
        if (!currentUser) {
            displayFormError(document.getElementById('create-ticket-error'), 'You must be logged in to create a ticket.');
            return;
        }
        if (!subject || !description || !category) {
            displayFormError(document.getElementById('create-ticket-error'), 'Please fill in all required fields.');
            return;
        }

        const newTicket = {
            id: tickets.length > 0 ? Math.max(...tickets.map(t => t.id)) + 1 : 1,
            userId: currentUser.id,
            subject,
            description,
            category,
            status: 'Open',
            attachments: attachments.map(file => ({ name: file.name, size: file.size, type: file.type })), // Store relevant file info
            createdAt: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            assignedTo: null,
            upvotes: 0,
            downvotes: 0,
            comments: [{
                userId: currentUser.id,
                text: "Ticket created.",
                timestamp: new Date().toISOString(),
                role: currentUser.role
            }]
        };
        tickets.push(newTicket);
        saveState();
        showToast('Ticket created successfully!', 'success');
        console.log(`[Notification Mock] Email to Admin: New ticket "${newTicket.subject}" created. Status: Open.`);
        document.getElementById('create-ticket-form').reset();
        document.getElementById('selected-files').innerHTML = ''; // Clear file previews
        renderTickets(); // Re-render dashboard to show new ticket
        switchView(views.dashboard);
    }

    function updateTicketStatus(ticketId, newStatus) {
        const ticketIndex = tickets.findIndex(t => t.id === ticketId);
        if (ticketIndex !== -1 && currentUser.role === 'agent') {
            const oldStatus = tickets[ticketIndex].status;
            tickets[ticketIndex].status = newStatus;
            tickets[ticketIndex].lastModified = new Date().toISOString();
            // Add comment about status change
            tickets[ticketIndex].comments.push({
                userId: currentUser.id,
                text: `Status changed from '${oldStatus}' to '${newStatus}'.`,
                timestamp: new Date().toISOString(),
                role: 'system' // or agent for more specific
            });
            saveState();
            showToast(`Ticket status updated to "${newStatus}".`, 'info');
            console.log(`[Notification Mock] Email to Ticket Creator (${users.find(u => u.id === tickets[ticketIndex].userId)?.email}): Ticket "${tickets[ticketIndex].subject}" status changed from "${oldStatus}" to "${newStatus}".`);
            renderTicketDetail(ticketId); // Re-render detail view
            renderTickets(); // Re-render dashboard
        } else if (ticketIndex === -1) {
            showToast('Ticket not found for status update.', 'error');
        } else {
            showToast('Permission denied to update ticket status.', 'error');
        }
    }

    function handleAddCommentToTicket(ticketId, commentText) {
        const ticketIndex = tickets.findIndex(t => t.id === ticketId);
        if (ticketIndex !== -1 && currentUser && commentText) {
            const ticket = tickets[ticketIndex];
            // Only allow user to comment on their own tickets or if agent
            if (currentUser.role === 'user' && ticket.userId !== currentUser.id) {
                showToast("You can only comment on your own tickets.", 'error');
                return;
            }

            const newComment = {
                userId: currentUser.id,
                text: commentText,
                timestamp: new Date().toISOString(),
                role: currentUser.role // Store the role of the commenter
            };
            ticket.comments.push(newComment);
            ticket.lastModified = new Date().toISOString(); // Update last modified
            saveState();
            showToast('Comment added successfully!', 'success');
            console.log(`[Notification Mock] Email to all participants: New comment on ticket "${ticket.subject}".`);
            document.getElementById('comment-text').value = '';
            renderTicketDetail(ticketId); // Re-render to show new comment
        } else {
            showToast('Comment text cannot be empty.', 'error');
        }
    }

    function handleVote(ticketId, type) {
        const ticket = tickets.find(t => t.id === ticketId);
        if (ticket) {
            // Simple logic: allow multiple votes for demo. In real app, track user votes.
            if (type === 'upvote') {
                ticket.upvotes = (ticket.upvotes || 0) + 1;
                document.getElementById('upvote-count').textContent = ticket.upvotes;
                showToast('Ticket upvoted!', 'success');
            } else if (type === 'downvote') {
                ticket.downvotes = (ticket.downvotes || 0) + 1;
                document.getElementById('downvote-count').textContent = ticket.downvotes;
                showToast('Ticket downvoted.', 'info');
            }
            saveState();
        }
    }

    function handleAssignTicket(ticketId) {
        const ticketIndex = tickets.findIndex(t => t.id === ticketId);
        if (ticketIndex !== -1 && currentUser.role === 'agent') {
            const ticket = tickets[ticketIndex];
            if (ticket.assignedTo) {
                showToast(`Ticket is already assigned to ${users.find(u => u.id === ticket.assignedTo).name}.`, 'warning');
                return;
            }
            ticket.assignedTo = currentUser.id;
            ticket.status = 'In Progress'; // Automatically change status
            ticket.lastModified = new Date().toISOString();
            ticket.comments.push({
                userId: currentUser.id,
                text: `Ticket assigned to ${currentUser.name} and status set to 'In Progress'.`,
                timestamp: new Date().toISOString(),
                role: 'system' // or agent
            });
            saveState();
            showToast('Ticket assigned to you and status updated!', 'success');
            renderTicketDetail(ticketId);
            renderTickets(); // Update dashboard for status change
        } else {
            showToast('Permission denied or ticket not found.', 'error');
        }
    }

    // --- Profile Editing Functions (New) ---
    function handleEditProfile(newName, newEmail) {
        // In a real app, this would involve server-side validation and updating user data
        if (newName && newEmail) {
            // Check if new email conflicts with existing users (excluding current user)
            const emailExists = users.some(u => u.email === newEmail && u.id !== currentUser.id);
            if (emailExists) {
                showToast('Email already in use by another account.', 'error');
                return;
            }

            currentUser.name = newName;
            currentUser.email = newEmail;
            // Update the user in the main users array as well
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].name = newName;
                users[userIndex].email = newEmail;
            }
            saveState();
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-email').textContent = currentUser.email;
            showToast('Profile updated successfully!', 'success');
            hideModal();
        } else {
            showToast('Name and Email cannot be empty.', 'error');
        }
    }

    function handleChangePassword(currentPassword, newPassword) {
        if (currentUser.password !== currentPassword) {
            showToast('Current password incorrect.', 'error');
            return;
        }
        if (newPassword.length < 6) {
            showToast('New password must be at least 6 characters.', 'error');
            return;
        }
        if (currentPassword === newPassword) {
            showToast('New password cannot be the same as the old password.', 'warning');
            return;
        }
        // In a real app, hash newPassword before saving
        currentUser.password = newPassword;
        const userIndex = users.findIndex(u => u.id === currentUser.id);
        if (userIndex !== -1) {
            users[userIndex].password = newPassword;
        }
        saveState();
        showToast('Password changed successfully!', 'success');
        hideModal();
    }


    function handleEditUserRole(userIdToEdit, newRole) {
        const userIndex = users.findIndex(u => u.id === userIdToEdit);
        if (userIndex !== -1) {
            if (userIdToEdit === currentUser.id && newRole !== currentUser.role) {
                showToast("You cannot change your own role directly. Please ask another admin.", 'error');
                return;
            }
            users[userIndex].role = newRole;
            saveState();
            showToast(`Role for ${users[userIndex].name} updated to "${newRole}".`, 'success');
            renderUserManagement(); // Re-render admin user list
            updateNavVisibility(); // In case admin changes their own role (though restricted)
        } else {
            showToast('User not found.', 'error');
        }
    }

    function handleDeleteUser(userIdToDelete) {
        if (userIdToDelete === currentUser.id) {
            showToast("You cannot delete your own account!", 'error');
            return;
        }
        showConfirmation(
            "Confirm User Deletion",
            `Are you sure you want to permanently delete this user? All their tickets will be marked as 'Closed' and their comments removed.`,
            () => {
                users = users.filter(u => u.id !== userIdToDelete);
                tickets.forEach(ticket => {
                    if (ticket.userId === userIdToDelete) {
                        ticket.status = 'Closed'; // Mark tickets as closed
                        ticket.comments.push({
                            userId: currentUser.id, // Admin who deleted
                            text: `Ticket creator's account was deleted by Admin. This ticket has been closed.`,
                            timestamp: new Date().toISOString(),
                            role: 'system'
                        });
                    }
                    // Filter out comments by the deleted user from all tickets
                    ticket.comments = ticket.comments.filter(comment => comment.userId !== userIdToDelete);
                });
                saveState();
                showToast('User deleted successfully and their tickets updated.', 'success');
                renderUserManagement();
                renderTickets(); // Update dashboard in case any of current user's tickets were affected
            }
        );
    }

    function handleAddCategory(categoryName) {
        if (!categoryName) {
            showToast('Category name cannot be empty.', 'warning');
            return;
        }
        // Capitalize first letter for display consistency
        const formattedCategoryName = categoryName.charAt(0).toUpperCase() + categoryName.slice(1).toLowerCase();

        if (categories.includes(formattedCategoryName)) {
            showToast('Category already exists.', 'warning');
            return;
        }
        categories.push(formattedCategoryName);
        saveState();
        showToast(`Category "${formattedCategoryName}" added.`, 'success');
        document.getElementById('new-category-name').value = '';
        populateCategoryDropdowns(); // Update all dropdowns
        renderCategoryManagement();
    }

    function handleDeleteCategory(categoryName) {
        showConfirmation(
            "Confirm Category Deletion",
            `Are you sure you want to delete the category "${categoryName}"? Tickets currently assigned to this category will remain, but this category will no longer be an option for new tickets.`,
            () => {
                categories = categories.filter(cat => cat !== categoryName);
                saveState();
                showToast(`Category "${categoryName}" deleted.`, 'success');
                populateCategoryDropdowns(); // Update all dropdowns
                renderCategoryManagement();
            }
        );
    }

    // --- Event Listeners ---

    // Theme Toggle
    themeToggleBtn.addEventListener('click', () => {
        const currentTheme = document.body.dataset.theme;
        if (currentTheme === 'dark') {
            document.body.removeAttribute('data-theme');
            themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            localStorage.setItem('theme', 'light');
        } else {
            document.body.setAttribute('data-theme', 'dark');
            themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            localStorage.setItem('theme', 'dark');
        }
    });

    // Mobile Navigation Toggle
    menuToggle.addEventListener('click', () => {
        mainNav.classList.toggle('menu-open');
    });

    // Navigation Items (delegated)
    mainNav.addEventListener('click', (e) => {
        if (e.target.closest('.nav-item') && !e.target.closest('#logout-btn')) {
            e.preventDefault();
            const navItem = e.target.closest('.nav-item');
            const targetViewName = navItem.dataset.navTarget;
            if (views[targetViewName]) {
                if (targetViewName === 'dashboard') {
                    renderTickets();
                } else if (targetViewName === 'profile') {
                    // Refresh profile info when navigating to it
                    if (currentUser) {
                        document.getElementById('profile-name').textContent = currentUser.name;
                        document.getElementById('profile-email').textContent = currentUser.email;
                        document.getElementById('profile-role').textContent = currentUser.role;
                    }
                } else if (targetViewName === 'admin' && currentUser.role === 'admin') {
                    renderUserManagement();
                    renderCategoryManagement();
                    // Auto-select first admin tab
                    const firstAdminTab = document.querySelector('.admin-tabs .tab-button');
                    if (firstAdminTab && !firstAdminTab.classList.contains('active')) {
                        firstAdminTab.click();
                    } else if (firstAdminTab && firstAdminTab.classList.contains('active')) {
                        // If already active, manually re-render based on its data-tab
                        const currentAdminTab = document.querySelector('.admin-tabs .tab-button.active');
                        if (currentAdminTab.dataset.adminTab === 'user-management') {
                            renderUserManagement();
                        } else if (currentAdminTab.dataset.adminTab === 'category-management') {
                            renderCategoryManagement();
                        }
                    }
                }
                switchView(views[targetViewName]);
            }
        }
    });

    // Logout Button
    logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        currentUser = null;
        saveState();
        updateNavVisibility();
        showToast('You have been logged out.', 'info');
        switchView(views.auth);
    });

    // Auth Tabs
    document.querySelectorAll('.auth-tabs .tab-button').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.auth-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('auth-error').style.display = 'none'; // Hide errors

            if (button.dataset.tab === 'login') {
                document.getElementById('login-form').classList.remove('hidden');
                // document.getElementById('login-form').classList.add('active'); // No need for 'active' on form directly
            } else {
                document.getElementById('register-form').classList.remove('hidden');
                // document.getElementById('register-form').classList.add('active');
            }
        });
    });

    // Login Form Submission
    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        handleLogin(email, password);
    });

    // Register Form Submission
    document.getElementById('register-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const role = document.getElementById('register-role').value;

        // Basic client-side validation
        if (!name || !email || !password || !role) {
            displayFormError(document.getElementById('auth-error'), 'Please fill in all registration fields.');
            return;
        }
        if (password.length < 6) {
            displayFormError(document.getElementById('auth-error'), 'Password must be at least 6 characters long.');
            return;
        }
        // Simple email format check
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            displayFormError(document.getElementById('auth-error'), 'Please enter a valid email address.');
            return;
        }

        handleRegister(name, email, password, role);
    });

    // Create Ticket Form Submission
    document.getElementById('create-ticket-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const subject = document.getElementById('ticket-subject').value.trim();
        const description = document.getElementById('ticket-description').value.trim();
        const category = document.getElementById('ticket-category').value;
        const attachments = Array.from(document.getElementById('ticket-attachment').files);

        // Basic validation
        if (!subject || !description || !category || category === '') { // Ensure category is selected
            displayFormError(document.getElementById('create-ticket-error'), 'Please fill in all required fields.');
            return;
        }
        if (attachments.some(file => file.size > 5 * 1024 * 1024)) { // 5MB limit
            displayFormError(document.getElementById('create-ticket-error'), 'Some attachments exceed the 5MB limit.');
            return;
        }
        if (attachments.length > 5) {
            displayFormError(document.getElementById('create-ticket-error'), 'You can only upload a maximum of 5 files.');
            return;
        }

        handleCreateTicket(subject, description, category, attachments);
    });

    // Handle file selection preview
    document.getElementById('ticket-attachment').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        const selectedFilesDiv = document.getElementById('selected-files');
        selectedFilesDiv.innerHTML = ''; // Clear previous previews

        if (files.length > 0) {
            files.forEach((file, index) => {
                const fileTag = document.createElement('span');
                fileTag.classList.add('file-tag');
                // Ensure unique data-file-index based on the actual file object if possible, or just the current index.
                // For simplicity here, we'll use array index.
                fileTag.innerHTML = `
                    <i class="fas fa-file"></i>
                    ${file.name}
                    <button type="button" class="remove-file" data-file-idx="${index}">&times;</button>
                `;
                selectedFilesDiv.appendChild(fileTag);
            });
        }
    });

    // Remove file from preview (doesn't actually remove from input file list, but visually hides it)
    document.getElementById('selected-files').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-file')) {
            const indexToRemove = parseInt(e.target.dataset.fileIdx);
            const input = document.getElementById('ticket-attachment');
            const files = new DataTransfer();
            Array.from(input.files)
                .filter((file, i) => i !== indexToRemove)
                .forEach(file => files.items.add(file));
            input.files = files.files;
            e.target.closest('.file-tag').remove(); // Remove visual tag

            // Re-render the file list after removal to update indices if needed
            // For robust handling, you might re-trigger the change event or re-render the selected files section.
            // For now, simpler approach, just remove the tag.
        }
    });


    // Dashboard Filters
    document.getElementById('status-filter').addEventListener('change', (e) => {
        currentFilters.status = e.target.value;
        currentFilters.page = 1;
        renderTickets();
    });

    document.getElementById('category-filter').addEventListener('change', (e) => {
        currentFilters.category = e.target.value;
        currentFilters.page = 1;
        renderTickets();
    });

    document.getElementById('my-tickets-filter').addEventListener('change', (e) => {
        currentFilters.myTickets = e.target.checked;
        currentFilters.page = 1;
        renderTickets();
    });

    document.getElementById('search-tickets').addEventListener('input', (e) => {
        currentFilters.search = e.target.value;
        currentFilters.page = 1;
        renderTickets();
    });

    document.getElementById('sort-by').addEventListener('change', (e) => {
        currentFilters.sortBy = e.target.value;
        currentFilters.page = 1;
        renderTickets();
    });

    // Pagination
    document.getElementById('prev-page').addEventListener('click', () => {
        if (currentFilters.page > 1) {
            currentFilters.page--;
            renderTickets();
        }
    });

    document.getElementById('next-page').addEventListener('click', () => {
        // Calculate total pages based on current filters for accurate pagination
        const totalItems = tickets.filter(t => {
            const matchesStatus = currentFilters.status === 'all' || t.status.toLowerCase().replace(/\s/g, '-') === currentFilters.status;
            const matchesCategory = currentFilters.category === 'all' || t.category.toLowerCase().replace(/\s/g, '-') === currentFilters.category;
            const matchesMyTickets = !currentFilters.myTickets || t.userId === currentUser.id;
            const matchesSearch = t.subject.toLowerCase().includes(currentFilters.search.toLowerCase()) ||
                                  t.description.toLowerCase().includes(currentFilters.search.toLowerCase());
            return matchesStatus && matchesCategory && matchesMyTickets && matchesSearch;
        }).length;
        const totalPages = Math.ceil(totalItems / currentFilters.itemsPerPage);

        if (currentFilters.page < totalPages) {
            currentFilters.page++;
            renderTickets();
        }
    });

    // Ticket Card Click (delegated for dynamically added cards)
    document.getElementById('ticket-grid').addEventListener('click', (e) => {
        const ticketCard = e.target.closest('.ticket-card');
        if (ticketCard && !ticketCard.classList.contains('skeleton')) {
            activeTicketId = parseInt(ticketCard.dataset.id);
            renderTicketDetail(activeTicketId);
        }
    });

    // Ticket Detail Page Actions (delegated)
    document.getElementById('ticket-detail-view').addEventListener('click', (e) => {
        if (e.target.closest('#upvote-btn')) {
            handleVote(activeTicketId, 'upvote');
        } else if (e.target.closest('#downvote-btn')) {
            handleVote(activeTicketId, 'downvote');
        } else if (e.target.closest('#assign-ticket-btn')) {
            handleAssignTicket(activeTicketId);
        } else if (e.target.closest('#add-comment-btn')) {
            const commentText = document.getElementById('comment-text').value.trim();
            handleAddCommentToTicket(activeTicketId, commentText);
        }
    });
    // Status update dropdown
    document.getElementById('agent-status-update').addEventListener('change', (e) => {
        const ticketId = parseInt(e.target.dataset.ticketId); // Get ticket ID from dropdown's dataset
        const newStatus = e.target.value;
        if (newStatus && newStatus !== '') { // Ensure a valid status is selected
            updateTicketStatus(ticketId, newStatus);
        }
    });

    // Profile Actions (mock modals for editing)
    document.querySelector('#profile-view .profile-actions').addEventListener('click', (e) => {
        if (e.target.textContent.includes('Edit Profile')) {
            // In a real scenario, you'd open a dedicated modal or inline form
            showToast('Edit Profile functionality (mock): Imagine a modal opens for name/email.', 'info');
            // For a quick demo, we can simulate an edit prompt
            const newName = prompt("Enter new name:", currentUser.name);
            const newEmail = prompt("Enter new email:", currentUser.email);
            if (newName !== null && newEmail !== null) {
                handleEditProfile(newName, newEmail);
            }

        } else if (e.target.textContent.includes('Change Password')) {
            showToast('Change Password functionality (mock): Imagine a modal opens for old/new password.', 'info');
            const currentPass = prompt("Enter current password:");
            if (currentPass !== null) {
                const newPass = prompt("Enter new password (min 6 chars):");
                if (newPass !== null) {
                    handleChangePassword(currentPass, newPass);
                }
            }
        }
    });


    // Admin Panel Tabs
    document.querySelectorAll('.admin-tabs .tab-button').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.admin-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            document.getElementById('user-management-panel').classList.add('hidden');
            document.getElementById('category-management-panel').classList.add('hidden');

            if (button.dataset.adminTab === 'user-management') {
                document.getElementById('user-management-panel').classList.remove('hidden');
                // document.getElementById('user-management-panel').classList.add('active'); // No need for 'active' on panel directly
                renderUserManagement();
            } else {
                document.getElementById('category-management-panel').classList.remove('hidden');
                // document.getElementById('category-management-panel').classList.add('active');
                renderCategoryManagement();
            }
        });
    });

    // Admin User Management Actions (delegated)
    document.getElementById('user-list-grid').addEventListener('click', (e) => {
        if (e.target.matches('[data-action="edit-role"]')) {
            const userId = parseInt(e.target.dataset.userId);
            const user = users.find(u => u.id === userId);
            if (user) {
                modalUserName.textContent = user.name;
                modalUserEmail.textContent = user.email;
                modalUserRole.value = user.role;
                saveRoleBtn.dataset.userId = userId; // Store ID on button
                showModal(editRoleModal);
            }
        } else if (e.target.matches('[data-action="delete-user"]')) {
            const userId = parseInt(e.target.dataset.userId);
            handleDeleteUser(userId);
        }
    });

    // Save Role Button in Modal
    saveRoleBtn.addEventListener('click', () => {
        const userId = parseInt(saveRoleBtn.dataset.userId);
        const newRole = modalUserRole.value;
        handleEditUserRole(userId, newRole);
        hideModal(); // Hide modal after action
    });

    // Admin Category Management Actions
    document.getElementById('add-category-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newCategoryName = document.getElementById('new-category-name').value.trim();
        handleAddCategory(newCategoryName);
    });

    document.getElementById('category-list-grid').addEventListener('click', (e) => {
        if (e.target.matches('[data-action="delete-category"]')) {
            const categoryName = e.target.dataset.categoryName;
            handleDeleteCategory(categoryName);
        }
    });

    // Modal Close Buttons (delegated)
    modalContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-container') || e.target.closest('[data-modal-close]')) {
            hideModal();
        }
    });

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modalContainer.classList.contains('active')) {
            hideModal();
        }
    });


    // --- Initialization ---
    function initializeApp() {
        // Set theme from localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            document.body.removeAttribute('data-theme');
            themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
        }

        if (currentUser) {
            updateNavVisibility();
            populateCategoryDropdowns();
            renderTickets(); // Initial render of dashboard
            switchView(views.dashboard);
        } else {
            // If no user, ensure auth view is active and navigation is hidden
            mainNav.classList.add('hidden');
            switchView(views.auth);
        }
    }

    initializeApp();
});
    </script>
</body>
</html>
